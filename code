# Import necessary libraries
import numpy as np
import matplotlib.pyplot as plt
from sklearn.datasets import load_digits
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import confusion_matrix, classification_report, ConfusionMatrixDisplay

# 1. Load the digits dataset
digits = load_digits()
X, y = digits.data, digits.target

print("Dataset shape:", X.shape)
print("Labels:", np.unique(y))

# 2. Split dataset into training and testing sets
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

# 3. Define the KNN model
knn = KNeighborsClassifier()

# 4. Use GridSearchCV to find the best 'k' (number of neighbors)
param_grid = {'n_neighbors': np.arange(1, 21)}  # test K = 1 to 20
grid_search = GridSearchCV(knn, param_grid, cv=5, scoring='accuracy')
grid_search.fit(X_train, y_train)

print("\nBest K value found:", grid_search.best_params_['n_neighbors'])
print("Best cross-validation score:", grid_search.best_score_)

# 5. Train the model with best K
best_k = grid_search.best_params_['n_neighbors']
best_knn = KNeighborsClassifier(n_neighbors=best_k)
best_knn.fit(X_train, y_train)

# 6. Evaluate the model on test data
y_pred = best_knn.predict(X_test)
accuracy = best_knn.score(X_test, y_test)

print("\nTest Accuracy:", accuracy)
print("\nClassification Report:\n", classification_report(y_test, y_pred))

# 7. Plot confusion matrix
cm = confusion_matrix(y_test, y_pred)
disp = ConfusionMatrixDisplay(confusion_matrix=cm, display_labels=digits.target_names)
disp.plot(cmap='Blues', xticks_rotation='vertical')
plt.title(f"Confusion Matrix (K = {best_k})")
plt.show()

# 8. (Optional) Plot accuracy vs K to visualize performance
k_values = np.arange(1, 21)
scores = [KNeighborsClassifier(n_neighbors=k).fit(X_train, y_train).score(X_test, y_test) for k in k_values]

plt.figure(figsize=(8, 5))
plt.plot(k_values, scores, marker='o')
plt.title('K Value vs Accuracy')
plt.xlabel('Number of Neighbors (K)')
plt.ylabel('Test Accuracy')
plt.grid(True)
plt.show()
